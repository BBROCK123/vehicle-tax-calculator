<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>חישוב מיסי רכב חשמלי M1 - יבוא אישי</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .calculator-title {
            text-align: center;
            color: #1a237e;
            margin-bottom: 30px;
            font-size: 24px;
        }
        .calculator-subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 18px;
        }
        .form-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .radio-group {
            margin-bottom: 15px;
        }
        .radio-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }
        .radio-options {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .result-box {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        .result-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a237e;
            margin: 10px 0;
        }
        .result-note {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        .back-button {
            background-color: #666;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }
        .back-button:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>חישוב מיסי רכב חשמלי M1</h1>
    </div>

    <div class="main-container">
        <div class="calculator-title">רכב חשמלי M1</div>
        <div class="calculator-subtitle">תחת מסלול יבוא אישי</div>

        <div class="form-container">
            <form id="calculator-form">
                <div class="form-group">
                    <label for="invoice-amount">1. סכום החשבונית במטבע חוץ</label>
                    <input type="number" id="invoice-amount" required placeholder="הכנס סכום">
                </div>
                <div class="form-group">
                    <label for="currency-type">2. סוג המטבע</label>
                    <input type="text" id="currency-type" required placeholder="הכנס סוג מטבע">
                </div>
                <div class="form-group">
                    <label for="exchange-rate">3. שער המטבע</label>
                    <input type="number" id="exchange-rate" step="0.0001" required placeholder="הכנס שער">
                </div>
                <div class="form-group">
                    <label for="shipping-cost">4. ערך ההובלה במטבע חוץ</label>
                    <input type="number" id="shipping-cost" required placeholder="הכנס עלות משלוח">
                </div>
                <div class="form-group">
                    <label for="local-expenses">5. הוצאות מקומיות בשח</label>
                    <input type="number" id="local-expenses" required placeholder="הכנס הוצאות מקומיות">
                </div>

                <div class="form-group">
                    <label for="manufacturing-date">6. תאריך ייצור הרכב</label>
                    <input type="date" id="manufacturing-date" required>
                    <div id="manufacturing-date-error" style="color: red; display: none; margin-top: 5px;">
                        לא ניתן לייבא רכב ביבוא אישי שגילו מעל 24 חודשים
                    </div>
                </div>

                <div class="radio-group">
                    <label>7. האם יש תעודת מקור, הצהרת מקור או קיום תנאים לקוד 815?</label>
                    <div class="radio-options">
                        <div class="radio-option">
                            <input type="radio" id="origin-yes" name="origin" value="yes" required>
                            <label for="origin-yes">כן</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="origin-no" name="origin" value="no" required>
                            <label for="origin-no">לא</label>
                        </div>
                    </div>
                </div>

                <div class="radio-group">
                    <label>8. האם המשקל הכולל עולה על 3500 ק"ג?</label>
                    <div class="radio-options">
                        <div class="radio-option">
                            <input type="radio" id="weight-yes" name="weight" value="yes" required>
                            <label for="weight-yes">כן</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="weight-no" name="weight" value="no" required>
                            <label for="weight-no">לא</label>
                        </div>
                    </div>
                </div>

                <div class="radio-group">
                    <label>9. האם המשקל הכולל עולה על 4500 ק"ג?</label>
                    <div class="radio-options">
                        <div class="radio-option">
                            <input type="radio" id="weight-4500-yes" name="weight-4500" value="yes" required>
                            <label for="weight-4500-yes">כן</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="weight-4500-no" name="weight-4500" value="no" required>
                            <label for="weight-4500-no">לא</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="israel-price">10. מה המחיר לצרכן בישראל של רכב חדש מהדגם שברצונך לייבא?</label>
                    <input type="number" id="israel-price" required placeholder="הכנס מחיר בשקלים">
                    <div style="color: #666; font-size: 14px; margin-top: 5px;">
                        הנתון בתיבה האפורה הוא תחשיב משוער בהתאם לנוסחת החישוב בהוראות החוק
                    </div>
                </div>

                <div class="result-box">
                    <div style="margin-bottom: 15px; font-weight: bold; color: #1a237e;">מחיר צרכן משוער:</div>
                    <div class="result-value" id="result-value">₪0</div>
                    <div class="result-note">* המחיר יתעדכן לאחר חישוב מס יוקרה</div>
                </div>

                <button type="submit" class="btn" id="submit-button">חשב</button>
            </form>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="back-button" onclick="window.location.href='calculator-type.html'">חזרה</button>
        </div>
    </div>

    <script>
        // הגדרת משתנים גלובליים לחישובים
        let customsValue = 0;
        let customsDuty = 0;
        let purchaseTax = 0;
        let purchaseTaxRate = 0;
        let vat = 0;
        let totalTaxes = 0;
        let totalTaxRate = 0;
        let totalValue = 0;
        let finalPrice = 0;
        let luxuryTaxData = null;

        // בדיקת תקופת הייצור
        function checkManufacturingDate() {
            const manufacturingDate = new Date(document.getElementById('manufacturing-date').value);
            const currentDate = new Date();
            const monthsDifference = (currentDate.getFullYear() - manufacturingDate.getFullYear()) * 12 + 
                                  (currentDate.getMonth() - manufacturingDate.getMonth());
            
            const errorElement = document.getElementById('manufacturing-date-error');
            const submitButton = document.getElementById('submit-button');
            
            if (monthsDifference > 24) {
                errorElement.style.display = 'block';
                submitButton.disabled = true;
                return false;
            } else {
                errorElement.style.display = 'none';
                submitButton.disabled = false;
                return true;
            }
        }

        // חישוב המחיר
        function calculatePrice() {
            if (!checkManufacturingDate()) {
                return;
            }

            const invoiceAmount = parseFloat(document.getElementById('invoice-amount').value) || 0;
            const exchangeRate = parseFloat(document.getElementById('exchange-rate').value) || 0;
            const shippingCost = parseFloat(document.getElementById('shipping-cost').value) || 0;
            const localExpenses = parseFloat(document.getElementById('local-expenses').value) || 0;
            const manufacturingDate = new Date(document.getElementById('manufacturing-date').value);
            const currentDate = new Date();
            const hasOriginDeclaration = document.querySelector('input[name="origin"]:checked')?.value === 'yes';
            const israelPrice = parseFloat(document.getElementById('israel-price').value) || 0;

            // חישוב ערך לצרכי מכס
            customsValue = (invoiceAmount * exchangeRate) + (shippingCost * exchangeRate) + localExpenses;

            // חישוב מכס (7% אם אין הצהרת מקור)
            customsDuty = hasOriginDeclaration ? 0 : customsValue * 0.07;

            // ערך לצרכי מס קנייה
            const purchaseTaxBase = customsValue + customsDuty;

            // חישוב מס קנייה בשתי אפשרויות
            const purchaseTaxOption1 = (purchaseTaxBase * 0.83) - 35000 - 19048;
            const purchaseTaxOption2 = purchaseTaxBase * 0.45;
            
            // חישוב מס יוקרה
            let luxuryTax = 0;
            let luxuryTaxRate = 0;
            if (israelPrice > 300000) {
                const excessAmount = israelPrice - 300000;
                luxuryTaxRate = (excessAmount / israelPrice) * 0.2 * 100;
                luxuryTax = (excessAmount / israelPrice) * 0.2 * purchaseTaxBase;
            }
            
            // בחירת הערך הגבוה מבין שתי האפשרויות והוספת מס יוקרה
            purchaseTax = Math.max(purchaseTaxOption1, purchaseTaxOption2) + luxuryTax;
            
            // חישוב שיעור מס קנייה נומינלי
            purchaseTaxRate = (purchaseTax / purchaseTaxBase) * 100;

            // ערך לצרכי מע"מ
            const vatBase = customsValue + customsDuty + purchaseTax;

            // חישוב מע"מ (18%)
            vat = vatBase * 0.18;

            // חישוב סך המיסים ושיעורם
            totalTaxes = customsDuty + purchaseTax + vat;
            totalTaxRate = (totalTaxes / customsValue) * 100;

            // ערך הרכב כולל מיסים
            totalValue = customsValue + totalTaxes;

            // חישוב חודשים מתאריך הייצור
            const monthsDifference = (currentDate.getFullYear() - manufacturingDate.getFullYear()) * 12 + 
                                  (currentDate.getMonth() - manufacturingDate.getMonth());
            
            // חישוב מקדם הזמן (1.0125^x)
            const timeFactor = Math.pow(1.0125, monthsDifference);

            // חישוב מחיר צרכן סופי
            finalPrice = totalValue * (1 + 0.2375 * timeFactor);
            document.getElementById('result-value').textContent = `₪${finalPrice.toLocaleString()}`;

            // העברת נתוני מס יוקרה לדף התוצאות
            luxuryTaxData = {
                rate: luxuryTaxRate,
                amount: luxuryTax
            };
        }

        // הוספת מאזיני אירועים לשדות הקלט
        document.querySelectorAll('input, select').forEach(input => {
            if (input.id !== 'israel-price') {  // לא מוסיפים מאזין לשדה המחיר לצרכן
                input.addEventListener('input', calculatePrice);
            }
        });

        // הוספת מאזין אירועים לשאלה 10
        const consumerPriceInput = document.getElementById('israel-price');
        consumerPriceInput.addEventListener('input', function() {
            // לא מבצעים חישוב אוטומטי
            // רק מעדכנים את הערך שנשמר
            const value = parseFloat(this.value) || 0;
            localStorage.setItem('consumer-price', value);
        });

        // הוספת מאזין אירועים לכפתור החשב
        document.getElementById('submit-button').addEventListener('click', function() {
            calculatePrice();
        });

        // טיפול בשליחת הטופס
        document.getElementById('calculator-form').addEventListener('submit', function(e) {
            e.preventDefault();
            if (checkManufacturingDate()) {
                calculatePrice();
                
                // בניית URL עם הפרמטרים
                const params = new URLSearchParams({
                    customsValue: customsValue,
                    customsDuty: customsDuty,
                    purchaseTax: purchaseTax,
                    purchaseTaxRate: purchaseTaxRate,
                    vat: vat,
                    totalTaxes: totalTaxes,
                    totalTaxRate: totalTaxRate,
                    totalValue: totalValue,
                    finalPrice: finalPrice,
                    luxuryTaxRate: luxuryTaxData.rate,
                    luxuryTaxAmount: luxuryTaxData.amount
                });
                
                // ניתוב לדף התוצאות עם הפרמטרים
                window.location.href = `results.html?${params.toString()}`;
            }
        });
    </script>
</body>
</html> 